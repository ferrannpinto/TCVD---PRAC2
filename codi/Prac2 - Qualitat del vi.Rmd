---
title: "Prac2 - Wine quality"
author: "Ferran Pintó Haro i Arnau Santos Ribelles"
date: "9/5/2022"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

# 0. Lectura del fitxer i preparació de les dades

### Llegeix el fitxer CensusIncome_clean.csv i guarda les dades en un objecte amb identificador denominat cens. Verifica que les dades s'han carregat correctament.

Carreguem els fitxers de dades i els guardem en dos objectes denominats *red_wine_df* i *white_wine_df*.

```{r}
red_wine_df <- read.csv('winequality-red.csv', sep= ",")
white_wine_df <- read.csv('winequality-white.csv', sep= ";")
```

Examinem els valors resum de cada tipus de variable.

```{r}
summary(red_wine_df)
str(red_wine_df)

summary(white_wine_df)
str(white_wine_df)
```

Veiem com tenim les mateixes variables en els dos datasets que sumen 12 variables. En el de vi negre tenim 1599 observacions i en el de vi blanc 4898, sent totes les variables numèriques i la de qualitat sent de tipus integer (sense decimals). Podem veure també els valors entre els que es troba cada variable.


# 1. Descripció del dataset

### Perquè és important i quina pregunta/problema pretén respondre?

El dataset conté informació relacionada amb les variants negre i blanca de la varietat de vi portuguès “Vinho Verde”. Segons els autors del conjunt de dades, per motius de privacitat i logística només hi ha variables fisicoquímiques (entrades) i sensorials (sortida), i no hi ha, per exemple, dades sobre tipus de raïm, marca de vi, preu de venta, etc. 


Comptem amb dos datasets (un per la variant blanca i un per la negre) que ajuntem posteriorment. Les 14 variables que conté el dataset final són:

**“type”**: valor categòric corresponent al tipus de varietat (white / red).

**“fixed acidity”**: valor numèric corresponent al la quantitat d’àcids implicats (que no s’evaporen fàcilment). 

**“volatile acidity”**: valor numèric corresponent a la quantitat d’àcid acètic en el vi.

**“citric acid”**: valor numèric corresponent a la quantitat d’àcid cítric. Entre 0 i 1.

**“residual sugar”**: valor numèric corresponent a la quantitat (grams/litre) de sucre que queda després de la parada de la fermentació.

**“chlorides”**: valor numèric corresponent a la quantitat de sal al vi.

**“free sulfur dioxide”**: valor numèric corresponent a la quantitat de la forma lliure del SO2.

**“total sulfur dioxide”**: valor numèric corresponent a la quantitat de formes lliures i lligades de SO2.

**“density”**: valor numèric corresponent a la densitat del vi.

**“pH”**: valor numèric corresponent al PH del vi. Escala de 0 (molt àcid) al 14 (molt bàsic).

**“sulphates”**: valor numèric corresponent a la quantitat de sulfats.

**“alcohol”**: valor numèric corresponent als graus d’alcohol que té el vi (percentatge d’alcohol). 

**“quality”**: qualitat percebuda del vi. Valor numèric entre 0 i 10.

**“quality_d”**: variable categòrica creada segons la qualitat del vi ("bo" si la qualitat és 7 o superior i "no bo" si és inferior a 7)


És un dataset rellevant per poder fer tasques de classificació i regressió, al tenir diferents variables numèriques corresponents a les propietats del vi i una variable corresponent a la qualitat percebuda. Així podrem observar quines característiques del vi estan més relacionades amb la qualitat.

És pretén respondre la pregunta següent:
**Quines són les propietats fisicoquímiques que fan que un vi sigui bo?**

Alhora que observar:
**Les propietats que fan que un vi sigui bo són les mateixes per vins negres i blancs?**



# 2. Integració i selecció de les dades d’interès a analitzar. 

### Pot ser el resultat d’addicionar diferents datasets o una subselecció útil de les dades originals, en base a l’objectiu que es vulgui aconseguir.

Integrarem els dos datasets per tenir un únic dataset corresponent a vins. Abans de fer-ho, com que ens interessarà saber la varietat de vi que correspon a cada registre, creem una columna anomenada "type" en els dos datasets que indiqui el tipus de vi que és: "White" si és vi blanc i "Red" si és negre.

```{r}
red_wine_df["type"] <- "Red"
white_wine_df["type"] <- "White"
```

Ara integrem els dos datasets en un de sol, anomenat "wine". Ho fem mitjançant una fusió vertical, per incloure nous registres a un dataset. Per fer-ho és important que el format de les bases de dades a integrar sigui el mateix, com hem comprovat.

```{r}
wine <- rbind(red_wine_df,white_wine_df)
```

Comprovem que té el número de files i columnes que hauria de tenir i veiem els 3 primers i últims registres.

```{r}
dim(wine)
head(wine,3)
tail(wine,3)
```

Ara tenim en un dataset les 6497 files corresponents als vins blanc i negre, amb les mateixes 13 files. Com esperavem, les tres primeres files corresponen a registres de vi negre (Red) i les tres últimes a vi blanc (White). No eliminarem files ja que les farem servir totes per observar la seva relació amb la qualitat.

# 3. Neteja de les dades. 

## 3.1. Zeros o elements buits

### Les dades contenen zeros o elements buits? Gestiona cadascun d’aquests casos.

Comprovem si el dataset té valors absents (NA).

```{r}
colSums(is.na(wine))
```

Veiem com no tenim cap element buit en el dataset, cap valor nul en cap columna. 

Observem ara els zeros.

```{r}
colSums(wine==0)
```

Veiem que la columna "citric.acid" té 151 zeros, però són vàlids ja que està al rang de valors possibles de la variable. Pot no haver-hi àcid cítric als vins. 

## 3.2. Valors extrems.

### Identifica i gestiona els valors extrems.

Observem primer la distribució de la "fixed acidity".

```{r}
boxplot(wine$fixed.acidity, main="Distribució fixed acidity")
```

Malgrat hi ha molts valors atípics, no es consideren anòmals i per tant no els tractem. 

Observem la distribució de la "volatile acidity".

```{r}
boxplot(wine$volatile.acidity, main="Distribució volatile acidity")
```

Malgrat hi ha molts valors atípics, no es consideren anòmals i per tant no els tractem. 


Observem la distribució de l'àcid cítric.

```{r}
boxplot(wine$citric.acid, main="Distribució citric acid")
```

En una cerca, s'ha trobat que la quantitat legal màxima d'àcid cítric en el vi és de 1 gram per litre, per tant, considerem anòmals els valors atípics a partir d'aquest valor.

Contem el número de files amb més d'1 gram d'àcid cítric per litre.

```{r}
nrow(wine[(wine$citric.acid > 1),])
```

Veiem que només tenim dues files i és un percentatge ínfim del total i decidim eliminar les files.

```{r}
wine <- wine[!(wine$citric.acid > 1),]
```


Observem ara la distribució del sucre residual.

```{r}
par(mfrow=c(1,2))
boxplot(wine$residual.sugar, main="Distribució residual sugar")
hist(wine$residual.sugar)
```

Considerem anòmals els valors per sobre de 30.

Contem el número de files amb valors per sobre dels 30 en sucre residual.

```{r}
nrow(wine[(wine$residual.sugar > 30),])
```

Veiem que només tenim tres files i és un percentatge ínfim del total i decidim eliminar les files.

```{r}
wine <- wine[!(wine$residual.sugar > 30),]
```


Observem ara la distribució de chlorides (quantitat de sal).

```{r}
boxplot(wine$chlorides, main="Distribució chlorides")
```

Malgrat hi ha molts valors atípics, no es consideren anòmals i per tant no els tractem. 


Observem ara la distribució del diòxid de sofre lliure.

```{r}
boxplot(wine$free.sulfur.dioxide, main="Distribució free sulfur dioxide")
```

Observem, entre d'altres, un valor atípic molt llunyà a la resta, que considerem anòmal. Considerem anòmals els valors superiors a 150, deixant la resta igual.

Veiem el número de files amb aquests valors.

```{r}
nrow(wine[(wine$free.sulfur.dioxide > 150),])
```

Veiem que només tenim una fila i decidim eliminar-la.

```{r}
wine <- wine[!(wine$free.sulfur.dioxide > 150),]
```


Observem ara la distribució del "total sulfur dioxide". 

```{r}
par(mfrow=c(1,2))
boxplot(wine$total.sulfur.dioxide, main="Distribució total sulfur dioxide")
hist(wine$total.sulfur.dioxide)
boxplot.stats(wine$total.sulfur.dioxide)$out
```

Veiem com tenim varis valors extrems, però no els considerem anòmals.


Observem ara la distribució de la densitat.

```{r}
par(mfrow=c(1,2))
boxplot(wine$density, main="Distribució density")
hist(wine$density)
boxplot.stats(wine$density)$out
```

No tenim cap outlier en la variable density.


Observem ara la distribució del pH.

```{r}
boxplot(wine$pH, main="Distribució pH")
```

Observem valors atípics en la distribució del pH, però són valors lògics dins l'escala del pH, per tant els donem per vàlids.


Mirem ara la distribució dels sulfats.

```{r}
par(mfrow=c(1,2))
boxplot(wine$sulphates, main="Distribució sulphates")
hist(wine$sulphates)
boxplot.stats(wine$sulphates)$out
```

Malgrat hi ha molts valors atípics, no es consideren anòmals i per tant no els tractem. Pel que s'ha vist cercant a Internet, és possible tenir fins a 2 grams per litre de sulfats.

Observem ara la distribució del percentatge d'alcohol.

```{r}
par(mfrow=c(1,2))
boxplot(wine$alcohol, main="Distribució alcohol")
hist(wine$alcohol, main="Histograma alcohol")
```

Malgrat hi ha valors atípics, no es consideren anòmals ja que pot haver-hi una graduació de 15% d'alcohol en un vi. Per tant no els tractem.

```{r}
boxplot(wine$quality, main="Distribució quality")
```

Apareixen com a valors extrems de la variable quality els valors 3, 8 i 9. Com que l'escala (el rang) de la variable va del 0 al 10, els donarem com a valors vàlids.



Cal dir que a l'eliminar les files en haver-hi valors considerats extrems, pot ser que en alguna variable no hagin aparagut valors extrems o valors que haguessim considerat extrems perquè en eliminar files amb el criteri d'una altra variable, hagin estat eliminades files que tenien valors extrems en altres columnes.

Tornem a observar la dimensió del dataset.

```{r}
dim(wine)
```

El dataset final de treball té 6491 files i 13 variables.

## 3. Altres. Distretització de la variable qualitat del vi.

Discretitzem la variable "quality", substituint els valors numèrics per etiquetes (bo/no bo). Per tant, es tracta de dicotomització. Amb aquesta variable nova podrem interpretar i comparar resultats. Classifiquem els 7 o superior com a "bo" i la resta com a "no bo".

```{r}
wine["quality_d"] <- cut(wine$quality, breaks = c(0,6.5,10), labels = c("no bo", "bo"))
plot(wine$quality_d, main="Variable quality discretitzada")
```

Observem ara el percentatge de vins bons amb un pie chart.

```{r}
# Número de vins bons i la resta
total_bo <- sum(wine$quality_d == "bo")
total_nobo <- sum(wine$quality_d == "no bo")

# Percentatges
perc_bo <- (total_bo*100)/nrow(wine)
perc_nobo <- (total_nobo*100)/nrow(wine)

# Gràfic de la proporció de vins bons i no bons
pie(c(perc_bo, perc_nobo), labels=paste0(c(round(perc_bo,1), round(perc_nobo,1)), "%"),
main = "Percentatge de vins bons")
legend("topleft", legend = c("Vins bons", "Vins no bons"), fill = c("white", "lightblue"))
```

# 4. Anàlisi de les dades.

## 4.1. Selecció dels grups de dades

### Selecció dels grups de dades que es volen analitzar/comparar (p. e., si es volen comparar grups de dades, quins són aquests grups i quins tipus d’anàlisi s’aplicaran?).

Un cop integrades i netejades les dades, és el moment de l'anàlisi de les dades. Preparem els grups de dades que volem analitzar o comparar. En aquest cas només tenim dues variables categòriques: quality_d, que indica si el vi és bo o no, i "type" que indica si el vi es negre o blanc.

Compararem si la qualitat del vi blanc i del vi negre són percebudes diferents, i farem alguns anàlisis diferenciats segons el tipus de vi. D'altra banda, utilitzarem els vins "bons" i els que no, per veure les diferències en les característiques.

ESPECIFICAR ANALISIS A FER

```{r}

```


## 4.2. Comprovació de la normalitat i homogeneïtat de la variància.

Per comprovar la normalitat de cada variable farem servir el test de Kolmogorov-Smirnov, ja que la prova de Shapiro-Wilk accepta fins a 5000 registres i en tenim més.

```{r}
ks.test(wine$fixed.acidity, pnorm, mean(wine$fixed.acidity), sd(wine$fixed.acidity))
ks.test(wine$volatile.acidity, pnorm, mean(wine$volatile.acidity), sd(wine$volatile.acidity))
ks.test(wine$citric.acid, pnorm, mean(wine$citric.acid), sd(wine$citric.acid))
ks.test(wine$residual.sugar, pnorm, mean(wine$residual.sugar), sd(wine$residual.sugar))
ks.test(wine$chlorides, pnorm, mean(wine$chlorides), sd(wine$chlorides))
ks.test(wine$free.sulfur.dioxide, pnorm, mean(wine$free.sulfur.dioxide), sd(wine$free.sulfur.dioxide))
ks.test(wine$total.sulfur.dioxide, pnorm, mean(wine$total.sulfur.dioxide), sd(wine$total.sulfur.dioxide))
ks.test(wine$density, pnorm, mean(wine$density), sd(wine$density))
ks.test(wine$pH, pnorm, mean(wine$pH), sd(wine$pH))
ks.test(wine$sulphates, pnorm, mean(wine$sulphates), sd(wine$sulphates))
ks.test(wine$alcohol, pnorm, mean(wine$alcohol), sd(wine$alcohol))
ks.test(wine$quality, pnorm, mean(wine$quality), sd(wine$quality))
```

Veiem com la normalitat de totes les variables (fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates, alcohol i quality), tenen un valor p inferior a 0.05, i acceptem que les dades no provenen d'una distribució normal ja que rebutgem la hipòtesi nul·la, en totes les variables.


Pel que fa a la homoscedasticitat, contrastem amb la prova de Levene la igualtat de variàncies entre grups que necessitarem saber posteriorment.

```{r}
library(car) # Llibreria pel test de homoscedasticitat (levene)

# Comprovant la homoscedasticitat entre tipus de vi en la variable qualitat.
leveneTest(quality ~ type, data = wine)
```

Observem que les variancies entre el vi blanc i negre són iguals pel que fa a la qualitat ja que el p-valor superior a 0.05 ens porta a acceptar la hipòtesis nul·la d'igualtat de variancies per als diferents tipus de vi.


***FALTA HOMOGENEÏTAT DE LA VARIÀNCIA, HA DE SER NOMÉS COMPROVADA LA QUE FAREM SERVIR?


## 4.3. Aplicació de proves estadístiques per comparar els grups de dades. 

### En funció de les dades i de l’objectiu de l’estudi, aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi diferents.

Fem una matriu de correlació entre les variables corresponents a les característiques i la variable quality. Com que a l'apartat anterior s'ha vist que les dades (cap variable) no segueix una distribució normal, la correlació serà fet amb Spearman, una alternativa no paramètrica que mesura el grau de dependència entre dues variables i no comporta cap suposició sobre la distribució de les dades.

```{r}
library(corrplot)
library(dplyr)

corrplot(corr = cor(x = select(wine, fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, 
                               density, pH, sulphates, alcohol, quality), method = "spearman"), 
         method = "number", type = "lower", cl.cex = 0.5, number.cex = 0.6, 
         tl.col = "black", tl.srt = 45, tl.cex = 0.6)
```

Atenent als coeficients de correlació *(method = "spearman")*, observem que les relacions més destacables respecte quality es donen amb alcohol (0.45) i density (-0.32). També veiem una relació negativa moderada entre chlorides i la qualitat (-0.30). La resta són relacions dèbils/baixes. Les dues correlacions anomenades són correlacions moderades: la primera implica que a mesura que en certa mesura, a mesura que augmenta l'alcohol, augmenta la qualitat percebuda del vi; i la segona implica que a mesura que augmenta la densitat, disminueix la qualitat. A mesura que augmenten els chlorides, disminueix en certa manera la qualitat.

Cal destacar també la relació entre les dues variables següents: la densitat (density) i l'alcohol (alcohol), amb un coeficient de -0.70. Aquesta forta correlació negativa ens fa pensar que degut a la química, la quantitat d'alcohol redueix la densitat, i d'aquí que la quantitat d'alcohol serà la millor opció com a predictor de la qualitat del vi.

El SO2 lliure i el SO2 total estan altament correlacionats entre si, com podiem esperar.


Podem fer la matriu de correlacions pels vins blancs i pels vins negres, per observar si aquestes correlacions es veuen accentuades en algun dels dos tipus de vins.

```{r}
white_wine <- subset(wine, type=="White")
red_wine <- subset(wine, type=="Red")


corrplot(corr = cor(x = select(white_wine, fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, 
                               density, pH, sulphates, alcohol, quality), method = "spearman"),
         method = "number", type = "lower", cl.cex = 0.5, number.cex = 0.6, 
         tl.col = "black", tl.srt = 45, tl.cex = 0.6, main = "Matriu correlacions vi blanc")


corrplot(corr = cor(x = select(red_wine, fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, 
                               density, pH, sulphates, alcohol, quality), method = "spearman"),
         method = "number", type = "lower", cl.cex = 0.5, number.cex = 0.6, 
         tl.col = "black", tl.srt = 45, tl.cex = 0.6, main = "Matriu correlacions vi negre")
```

Veiem com en el cas dels vins blancs les correlacions relacionades amb la qualitat són molt similars.

En el cas dels vins negres, la relació de densitat amb la qualitat ara és de -0.18 (molt dèbil), la relació de l'alcohol amb la qualitat augmenta una mica respecte el total (0.48) i apareix una altra correlació mitjana, entre la volatilitat de l'acidesa (volatile acidity) i la qualitat (-0.38), en el sentit que a més acidesa volàtil, menys qualitat. Tampoc té gaire rellevància la correlació entre els chlorides i la qualitat (coeficient de -0.19) 


-----

Com que hem vist que l'alcohol està correlacionat amb la qualitat del vi, observem la distribució de la variable alcohol segons si el vi és bo o no:

```{r}
boxplot(wine$alcohol ~ wine$quality_d, main="Distribució alcohol segons bo/no bo")
```

Ara cal analitzar estadísticament si la mitjana d'alcohol és diferent pels vins bons i els vins no bons. Per fer-ho, farem un contrast d'hipòtesi per la diferència de mitjanes de alcohol.

La pregunta de recerca és:

**"La quantitat d'alcohol és diferent en els vins bons i els vins no bons?"**

La *hipòtesi nul·la (H0)* és que la mitjana d'alcohol és iguals entre vins bons i dolents.

La *hipòtesi alternativa (H1)* és que la mitjana d'alcohol és diferents entre vins bons i dolents.

Apliquem un test de dues mostres sobre la mitjana amb variàncies desconegudes. Pel teorema del límit central podem assumir normalitat.

Per utilitzar l'estadístic adequat cal comprovar la igualtat de variàncies de les dues poblacions:

```{r}
vibo <- wine[wine$quality_d == "bo",]
vinobo <- wine[wine$quality_d == "no bo",]

var.test(vibo$alcohol, vinobo$alcohol)
```

El resultat del test és un valor p<0.05. Rebutgem la hipòtesi nul·la d'igualtat de variàncies: assumim que les variàncies són diferents amb un nivell de confiança del 95%. En conseqüència, el test correspondrà a un test de dues mostres independents sobre la mitjana amb variàncies desconegudes diferents.

```{r}
t.test(vibo$alcohol, vinobo$alcohol, alternative = "two.sided", var.equal=FALSE, conf.level=0.95)
```

El valor p del test és inferior a 0.05, per tant amb un nivell de confiança del 95% podem rebutjar la hipòtesi nul·la d'igualtat de mitjanes, i podem afirmar que la mitjana de alcohol és estadísticament diferent entre els vins bons i els no bons. Si veiem les mitjanes, veiem que la mitjana d'alcohol és més alta en els vins bons (11.43 graus) que en els vins no bons (10.26 graus).  


***MÉS CONSTRAST D'HIPÒTESI?

...........

QUALITAT DE VINS BLANCS I NEGRES

Volem observar si les mitjanes de qualitat entre vins blancs i negres són les mateixes.

Malgrat no es compleix la normalitat, apliquem el teorema central del límit (que s'aplica a la mitjana de la mostra d'un conjunt de dades), i considerem que les dades segueixen una distribució normal, al tenir mides de les mostres grans. Pel que fa a la homoscedasticitat, en l'apartat 4.2 hem vist que les variàncies entre grups (tipus de vi) són iguals pel que fa a la variable qualitat.

Per tant, com que es compleixen els supòsits, podem aplicar la prova t de Student pel contrast d'hipòtesis. 

```{r}
# Comparem mitjanes de la qualitat entre el tipus de vi
t.test(quality ~ type, data = wine)
```

Veiem com el p-valor de la prova és menor al nivell de significació (0.05), i rebutgem la hipòtesi nula; concloent que existeixen diferències estadísticament significatives entre el vi blanc i el negre en la qualitat percebuda. El vi blanc és percep amb una millor qualitat.

..............
(Si no es compleixen les condicions s'han d'aplicar podem aplicar una prova no paramètrica com Mann-Whitney (els grups de dades són independents).)
 (Prova per comparar mitjanes de la qualitat entre tipus de vi pq no es compleixen les condicions)
 (wilcox.test(quality ~ type, data = wine))


REGRESSIÓ

Utilitzem la funció lm per ajustar un model de regressió. Mostrem el gràfic amb la recta de regressió entre quality i les variables amb més correlació amb aquesta variable objectiu.

```{r}
regr1 <- lm(alcohol ~ quality, data = wine)
summary(regr1)

plot(wine$alcohol, wine$quality, main = "Recta de regressió amb núvol de punts", pch=20)
abline(regr1, col="red") # FALTA QUE SURTI BÉ LA LINIA DE REGRESSIÓ, NO SE PQ NO SURT
```

Pel que fa a aquest model, és significatiu (p-valor menor que 0.05). Pel que fa a la bondat de l'ajust, el coeficient de determinació R2 és capaç d'explicar el 19.81%  de la variabilitat present en la variable de resposta (quality) mitjançant la variable independent (alcohol).

**Si afegim la resta de variables al model, veiem que................ (fer un model de regressió lineal múltiple amb totes les variables i anar-les reduint fins a tenir el millor model de regressió per predir la qualitat). Intentem construir el millor model per predir la qualitat del vi.





LES MILLORS VARIABLES PER PREDIR LA QUALITAT DEL VI SÓN...


*** PODEM FER REGRESSIÓ LOGÍSTICA PER PREDIR EL RESULTAT DE QUALITAT DEL VI BO/NO BO, ja que és una variable dicotòmica dependent.
